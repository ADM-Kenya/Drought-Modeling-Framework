#==============================================================================#
#' Script to calculate the Percentage of Precipitation and the Drought         # 
#' Vulnerability Index                                                         #
#' 
#' This code is used to calculate the percentage of irrigation based on the    #
#' farming systems classification and the drought vulnerability index (DVI)    #
#' based on different vulnerability indicators (GDP, population density,       # 
#' livestock density, percent irrigation, and relative wealth index(RWI)).     #
#' Additionally, the entire input data is re-sampled to the spatial resolution #
#' of the drought model output and the indicators are masked to exclude urban  #
#' areas and normalized to adjust the value ranges to a scale from 0 to 1.     #
#' In the end the DVI is masked to only represent areas of cropland, shurbland #
#' as well as areas with herbaceous vegetation.                                #
#'                                                                             #
#' The user needs to specify:                                                  #
#'                                                                             #
#' @param farmingSystems_file The path to the file with the results of the     #
#'                            farming systems classification.                  #
#' @param model_dir The directory with the results of the drought model.       #
#' @param aoi The path to the shapefile of Kenya.                              #
#' @param input_dir The path to the directory containing the input data for the#
#'                  DVI calculation (GDP, population and livestock density,    #
#'                  percentage of irrigation, and relative wealth index (RWI)).#
#' @param lc_dir The path to the directory containing the Copernicus Land Cover# 
#'               classification as well as different land cover masks.         #
#' @param normData_dir Thepath to the directory where the normalized input data#
#'                     will be stored.                                         #
#' @param output_dir The path to the directory where the output should be      #
#'                   saved.                                                    #
#==============================================================================#



# Install and load the required packages
#install.packages("terra")
#install.packages("dplyr")

#library(terra)
#library(dplyr)



########## Directories ##########
#farmingSystems_file <- choose.files(caption = "Select Farming Systems Classification File")
# farmingSystems_file <- "E:/Maxi/00_Farming_Systems/02_Data/Agri_areas_corrected_slope_ls_3.tif"
#input_dir <- choose.dir(caption = "Select Folder with the Input Data for the DVI Calculation")
#input_dir <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/02_Data"
#lc_dir <- choose.dir(caption = "Select Folder containing the Copernicus Land Cover Data")
# lc_dir <- "E:/Maxi/04_copernicus_landcover"
#model_dir <- choose.dir(caption = "Select Folder with the Results of the Drought Model")
# model_dir <- "E:/Maxi/06_Drought_Model/03_modelOutput_Sarah/05_copernicusLC_cropHerbShrub_Sarah"
#aoi <- choose.dir(caption = "Select Shapefile of Kenya")
# aoi <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/04_Kenya_ROI_Sarah/kenya.shp"
#normData_dir <- choose.dir(caption = "Select Folder to store the normalized Input Data")
# normData_dir <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/03_normalizedData"
#output_dir <- choose.dir(caption = "Select Folder with the Subfolders to store the Percentage of Irrigation and the Drought Vulnerability Data")
# output_dir <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/05_output"



########## Functions ##########

#' Calculate Percentage of Irrigation
#' 
#' This function calculates the percentage of irrigation from the farming systems
#' classification by computing the sum of pixels that are irrigated within a moving
#' window of the size 100 x 100 pixels and dividing the value by the total number 
#' of pixels of this window (10,000). Additionally, the raster is resampled to the 
#' spatial resolution of the drought model output (0.0125 degree or ~1km), clipped
#' to the extent of Kenya and saved.
#' 
#' @param farmingSystems_file The path to the file with the results of the 
#'                            farming systems classification.
#' @param model_dir The directory with the results of the drought model.
#' @param aoi The path to the shapefile of Kenya.
#' @param output_dir The path to the directory to store the output raster file.

percentage_irrigation <- function(farmingSystems_file, model_dir, aoi, output_dir){
  
  ########## Data Import ##########
  
  # Load farming systems classification raster
  farmingSystems <- rast(farmingSystems_file)
  
  # Load one of the model output files as reference raster for re-sampling
  ref_raster <- rast(list.files(model_dir, pattern = ".tif", recursive = T,
                                full.names = T)[1])
  
  # Load shapefile of Kenya
  aoi <- vect(aoi)
  
  ########## Calculate Percentage of Irrigation ##########
  
  # Set all NA values of the farming systems classification to 0
  farmingSystems <- farmingSystems %>% replace(is.na(.), 0)
  
  # Calculate percentage of irrigated farming systems
  percent_irrigation <- aggregate(x = farmingSystems, fact = 100, 
                                  fun = function(x){sum(x == 1)/10000})
  
  ########## Clip and Resample ##########
  
  # Crop and mask percentage of irrigation the the shape of the AOI
  percent_irrig_crop <- crop(percent_irrigation, ext(aoi))
  percent_irrig_mask <- mask(percent_irrig_crop, aoi)
  
  # Resample data to the same spatial resolution of the reference raster 
  # (0.01 degree of latitude or ~ 1.113 km)
  percent_irrig_mask_res <- terra::resample(percent_irrig_mask, ref_raster, method = "bilinear")
  
  ########## Write Data ##########
  
  # Define output name
  out_name <- paste0(output_dir, "/Percent_Irrigation_Kenya.tif")
  
  writeRaster(percent_irrig_mask, out_name, filetype = "GTiff", overwrite = T)
}


#' Calculate Drought Vulnerability Index (DVI)
#' 
#' This function calculates the drought vulnerability index from different indicators
#' (GDP, population density, livestock density, percent irrigation, and relative 
#' wealth index(RWI)). Before the DVI can be calculated the population density is
#' capped to 300 counts per km^2 which referrers to urban areas (which are excluded).
#' Then it calculates the mean livestock density from the sheep, goat and cattle 
#' density. Additionally, it resamples the vulnerability data, the Copernicus Land 
#' Cover raster, and the land cover mask (cropland, herbs, shrubs) to the spatial 
#' resolution of the drought model output (0.0125 degree or ~1.113 km). After the 
#' resampling step, it uses the Copernicus Land Cover to create a mask for urban 
#' areas and applies it to the vulnerability data. Then, it normalizes the input 
#' data and inverts the values of GDP, percentage of irrigation, and relative wealth 
#' index. Afterwards, the DVI is calculated by computing the sum of the vulnerability 
#' layers and dividing it by the number of input layers. The result is masked with
#' the crop/ herb/ shrub mask and then saved.
#' 
#' @param input_dir The path to the directory containing the input data for the
#'                  DVI calculation (GDP, population and livestock density, 
#'                  percentage of irrigation, and relative wealth index (RWI)).
#' @param lc_dir The path to the directory containing the Copernicus Land Cover 
#'               classification as well as different land cover masks.
#' @param model_dir The path to the directory with the results of the drought model.
#' @param normData_dir Thepath to the directory where the normalized input data 
#'                     will be stored.
#' @param output_dir The path to the directory where the output should be saved.

drought_vulnerability_index <- function(gdp, popdens, rwi, livestock, percprec, lc_dir, lcmask_dir, model_dir, normData_dir, output_dir){
  
  ########## Data Import ##########
  
  # Gross Domestic Product (2020, 30 arcsec, Zenodo)
  GDP <- rast(gdp)
  
  # Population Density Data (2020, 30 arcsec, WorldPop Hub)
  popDens <- rast(popdens)
  
  # Relative Wealth Index (2020, Humanitarian Data Exchange)
  RWI <- rast(rwi)
  
  # Sheep, Goat, Cattle Density 
  # (2015, Harvard Dataverse: Gridded Livestock of the World - 2015 (GLW 4), 1km)
  livestockDens <- rast(list.files(livestock, pattern = "*Density_2015_areaWeighted.tif$",
                                       recursive = T, full.names = T))
  
  # Farming Systems Classification
  precip <- rast(percprec)
  
  # Copernicus Land Cover (100m)
  lc <- rast(lc_dir)
  
  # Copernicus cropland, shrub and herbs mask
  mask <- rast(lcmask_dir)
  
  # Model output reference raster for resampling 
  # (in this case, the mask also could be used as reference raster)
  ref_raster <- rast(list.files(model_dir, pattern = ".tif", recursive = T,
                                full.names = T)[1])
  
  ########## Pre-Processing ##########
  
  # Cap the population density by setting pixels with values above 300 to 300
  popDens <- clamp(popDens, upper = 300, values = T)
  
  # Cap the GDP by setting pixels with values above 750,000 to 750,000
  GDP <- clamp(GDP, upper = 750000, values = T)
  
  # Calculate mean of livestock density
  livestockDens_mean <- app(livestockDens, mean, na.rm = T)
  names(livestockDens_mean) <- "ken_livestockDensity_2015_mean"
  
  ########## Resampling ##########
  
  # Resample all raster files to the spatial rolution of the drought model results 
  # 0.0125 degree of latitude or ~1.3875km
  GDP_res <- terra::resample(GDP, ref_raster, method = "bilinear")
  popDens_res <- terra::resample(popDens, ref_raster, method = "bilinear")
  livestockDens_mean_res <- terra::resample(livestockDens_mean, ref_raster, method = "bilinear")
  RWI_res <- terra::resample(RWI, ref_raster, method = "bilinear")
  precip_res <- terra::resample(precip, ref_raster, method = "bilinear")
  lc_res <- terra::resample(lc, ref_raster, method = "near")
  mask_res <- terra::resample(mask, ref_raster, method = "near")
  
  ########## Masking Urban Areas ##########
  
  # Combine the input data
  input_data <- list(GDP_res, popDens_res, livestockDens_mean_res, precip_res, RWI_res)  
  
  # Create urban mask: population density > 300 counts per km2 = urban
  # urban_mask <- ifel(population_density > 300, 1, 0)
  
  # Create an alternative urban mask with the Copernicus Land Cover 
  urban_mask <- ifel(lc_res == 50, 0, 1)
  urban_mask[urban_mask == 0] <- NA
  
  # Mask data with urban area mask
  for (i in 1:length(input_data)) {
    input_data[[i]] <- mask(input_data[[i]], urban_mask)
  }
  
  ########## Normalizing (0 to 1) ##########
  
  # Function to re-scale (normalize) data to new range (0-1)
  range_0_1 <- function(x){
    minmax <- range(values(x), na.rm = TRUE)
    return((x - minmax[1]) / (diff(minmax)))
  }
  
  # Normalize input data (0-1)
  for (i in 1:length(input_data)) {
    input_data[[i]] <- range_0_1(input_data[[i]])
  }
  
  ########## Drought Vulnerability Index (DVI) ##########
  
  # Invert the GDP, Irrigation Percent, and Relative Wealth Index raster files
  input_data[[1]] <- 1 - input_data[[1]] # GDP
  input_data[[4]] <- 1 - input_data[[4]] # Percent Irrigation
  input_data[[5]] <- 1 - input_data[[5]] # Realtive Wealth Index
  
  # Convert the list to a raster stack
  input_rast <- rast(input_data)

  # Calculate the DVI: (GDP + Population Density + Livestock Density + Percentage
  # of Precipitation + Relative Wealth Index) / 5
  dvi <- sum(input_rast, na.rm = T) / 5
  
  ########## Cropland/ Herb/ Shrub Mask ##########
  
  # Mask the DVI with the Copernicus mask for cropland, shurbs and herbacious vegetation
  dvi <- mask(dvi, mask)
  
  ########## Write Result ##########
  
  # Define output file names and paths
  dvi_name <- paste0(output_dir, "/droughtVulnerabilityIndex.tif")
  
  input_data_name <- NULL
  for (i in 1:length(input_data)) {
    input_data_name[i] <- paste(normData_dir, "/", names(input_rast)[i], "_norm.tif", sep = "")
  }
  
  # Save output raster files
  writeRaster(dvi, filename = dvi_name, filetype = "GTiff", overwrite = T)
  
  for (i in 1:length(input_data)) {
    writeRaster(input_rast[[i]], filename = input_data_name[i],
                filetype = "GTiff", overwrite = T)
  }
}
