#==============================================================================#
#' Script to calculate the Drought Risk                                        #
#'                                                                             #
#' This code is used to calculate the drought risk for the predicted months    #
#' based on the results of the drought model and the Drought Vulnerability     #
#' Index (DVI). The drought risk is calculated for every month of the predicted#
#' years. Additionally, the mean drought risk for every year and growing season#
#' is computed.                                                                #
#'                                                                             #
#' The user needs to specify:                                                  #
#'                                                                             #
#' @param input_dir The path to the directory with the results from the drought#
#'                  model (drought probability maps).                          #
#' @param dvi_file The path to the drought vulnerability index file.           #
#' @param output_dir The path to the directory where the output files of the   #
#'                   drought risk calculation will be stored.                  #
#==============================================================================#



# Install and load the required packages
#install.packages("terra")

#library(terra)



########## Paths and Variables ##########

### PATHS:
#input_dir <- choose.dir(caption = "Select Folder with Model Output Data")
# input_dir <- "E:/Maxi/06_Drought_Model/03_modelOutput_Sarah/05_copernicusLC_cropHerbShrub_Sarah"
#dvi_file <- choose.files(caption = "Select File with DVI Data")
# dvi_file <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/05_output/02_droughtVulnerabilityIndex/droughtVulnerabilityIndex.tif"
#output_dir <- choose.dir(caption = "Select Folder to store Output Data")
# output_dir <- "E:/Maxi/06_Drought_Model/Drought Risk and Vulnerability/05_output/03_droughtRisk"

### VARIABLES:
#predicted_years <- winDialogString("Enter the years for which the drought probabiliy was predicted (Drought Model Output). Use format: YYYY, YYYY, ...", "")
#predicted_years <- strsplit(predicted_years, ",\\s*")[[1]]
# predicted_years <- c("2018", "2022")
#season <- winDialogString("Enter the months of the growing season. Use format: MM, MM, ...", "")
#season <- strsplit(season, ",\\s*")[[1]]
# season <- c("04", "05", "06", "07", "11", "12")


########## Functions ##########

#' Function to calculate the Drought Risk 
#' 
#' This function calculates the drought risk for the predicted months based on 
#' the results of the drought model and the Drought Vulnerability Index (DVI). 
#' The drought risk is calculated for every month of the predicted years. 
#' Additionally, the mean drought risk for every year and growing season is computed.                                                                
#'                                                                             
#' @param input_dir The path to the directory with the results from the drought
#'                  model (drought probability maps).                          
#' @param dvi_file The path to the drought vulnerability index file.           
#' @param output_dir The path to the directory where the output files of the   
#'                   drought risk calculation will be stored. 

drought_risk_calc <- function(hazard_dir, dvi_file, output_dir){
  
  # Import Drought Vulnerability Index data
  dvi <- rast(dvi_file)
  
  # Calculate the drought risk for the data of one year at a time
  for (i in 1:length(predicted_years)) {
    # Extract the year
    year <- predicted_years[i]
    
    ########## Data Import ##########
  
    # Import the results of the drought model
    input_data <- rast(list.files(hazard_dir, pattern = year, recursive = T, full.names = T))  
    
    ########## Extract Date and Month ##########
  
    # Extract the date of the drought model files
    date_list <- NULL
  
    for(i in 1:nlyr(input_data)){
      file_name <- sources(input_data[[i]])
      date <- regmatches(file_name, regexpr("\\d{4}-\\d{2}-\\d{2}", file_name))
      names(input_data[[i]]) <- date
      date_list[i] <- date
    }
  
    # Extract months of dates
    months_list <- substr(date_list, 6, 7)
  
    # Filter dates for target months (growing season)
    months_growingSeason <- date_list %in% paste0(substr(date_list, 1, 4), "-", 
                                                 season, "-01")
    # dates_growingSeason <- date_list[months_growingSeason]
  
    # Subset input data for growing season
    input_data_growingSeason <- input_data[[months_growingSeason]]
  
    ########## Drought Hazard ##########
  
    # Calculate mean of hazard
    mean_hazard <- terra::mean(input_data, na.rm = T)
  
    # Calculate mean hazard of growing season
    mean_hazard_growingSeason <- terra::mean(input_data_growingSeason, na.rm = T)
    
    ########## Drought Risk ##########
    
    # Calculate drought risk for year
    risk_year <- mean_hazard * dvi
    
    # Calculate drought risk for growing season
    risk_growingSeason <- mean_hazard_growingSeason * dvi
    
    # Calculate drought risk for months
    risk_months <- list()
    
    for (i in 1:nlyr(input_data)) {
      risk_months[[i]] <- input_data[[i]] * dvi
    }
    
    risk_months <- rast(risk_months)
  
    ########## Write Results ##########
  
    # Write mean of hazard
    writeRaster(mean_hazard, filename = paste(output_dir, "/meanDroughtProbability_", year, ".tif", sep = ""),
                filetype = "GTiff", overwrite = T)
    
    # Write mean hazard of growing season
    writeRaster(mean_hazard_growingSeason, filename = paste(output_dir,"/meanDroughtProbability_growingSeason_", year, ".tif", sep = ""),
                filetype = "GTiff", overwrite = T)
    
    # Write drought risk for year
    writeRaster(risk_year, filename = paste(output_dir,"/droughtRisk_", year, ".tif", sep = ""),
                filetype = "GTiff", overwrite = T)
    
    # Write drought risk for growing season
    writeRaster(risk_growingSeason, filename = paste(output_dir,"/droughtRisk_growingSeason_", year, ".tif", sep = ""),
                filetype = "GTiff", overwrite = T)
    
    # Write drought risk for months
    for (i in 1:nlyr(risk_months)) {
      writeRaster(risk_months[[i]], filename = paste(output_dir,"/droughtRisk_", date_list[i], ".tif", sep = ""),
                  filetype = "GTiff", overwrite = T)
    } 
  }
}